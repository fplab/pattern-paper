% !TEX root = ./pattern-paper.tex
\section{preservation and progress}

\begin{lem}[Finality]
  \label{lem:finality}
  There doesn't exist such an expression $e$ such that both $\isFinal{e}$ and $\htrans{e}{e'}$ for some $e'$
\end{lem}
\begin{proof}Assume there exists such an $e$ such that both $\isFinal{e}$ and $\htrans{e}{e'}$ for some $e'$ then proof by contradiction.
 
  By rule induction over Rules (\ref{rules:Final}) and Rules (\ref{rules:ITExp}), \textit{i.e.}, over Rules (\ref{rules:Value}) and Rules (\ref{rules:ITExp}) and over Rules (\ref{rules:Indet}) and Rules (\ref{rules:ITExp}) respectively. The proof can be done by straightforward observation of syntactic contradictions.
\end{proof}

\begin{lem}
  \label{lem:no-e-satisfy-falsity}
  $\cnotsatisfy{e}{\cfalsity}$
\end{lem}
\begin{proof}
  By rule induction over Rules (\ref{rules:Satisfy}), we notice that $\csatisfy{e}{\cfalsity}$ is in syntactic contradiction with all rules, hence not derivable.
\end{proof}

\begin{lem}
  \label{lem:no-e-may-satisfy-falsity}
  $\cnotmaysatisfy{e}{\cfalsity}$
\end{lem}
\begin{proof}
  By rule induction over Rules (\ref{rules:MaySatisfy}), we notice that $\cmaysatisfy{e}{\cfalsity}$ is in syntactic contradiction with all rules, hence not derivable.
\end{proof}

\begin{lem}
  \label{lem:relax-nn-satisfy}
  $\csatisfyormay{e}{\xi}$ iff $\csatisfyormay{e}{\cor{\xi}{\cfalsity}}$
\end{lem}
\begin{proof}
  We prove sufficiency and necessity separately.
  \begin{enumerate}
    \item Sufficiency:
      \begin{pfsteps*}
      \item $\csatisfyormay{e}{\xi}$ \BY{assumption} \pflabel{nnsatisfyxi}
      \end{pfsteps*}
      By rule induction over Rules (\ref{rules:satormay}) on \pfref{nnsatisfyxi}.
      \begin{byCases}
      \item[\text{(\ref{rule:CMSPossibly})}]
        \begin{pfsteps*}
        \item $\cmaysatisfy{e}{\xi}$ \BY{assumption} \pflabel{maysatisfyxi}
        \item $\cmaysatisfy{e}{\cor{\xi}{\cfalsity}}$ \BY{Rule (\ref{rule:CMSOr1}) on \pfref{maysatisfyxi} and Lemma \ref{lem:no-e-satisfy-falsity}} \pflabel{maysatisfyxi+bot}
        \item $\csatisfyormay{e}{\cor{\xi}{\cfalsity}}$ \BY{Rule (\ref{rule:CMSPossibly}) on \pfref{maysatisfyxi+bot}}
        \end{pfsteps*}

      \item[\text{(\ref{rule:CMSMust})}]
        \begin{pfsteps*}
        \item $\csatisfy{e}{\xi}$ \BY{assumption} \pflabel{satisfyxi}
        \item $\csatisfy{e}{\cor{\xi}{\cfalsity}} \BY{Rule (\ref{rule:CSOr1}) on \pfref{satisfyxi}} \pflabel{satisfyxi+bot}
        \item $\csatisfyormay{e}{\cor{\xi}{\cfalsity}} \BY{Rule (\ref{rule:CMSMust}) on \pfref{satisfyxi+bot}}
        \end{pfsteps*}

      \end{byCases}

    \resetpfcounter

    \item Necessity:
      \begin{pfsteps*}
      \item $\csatisfyormay{e}{\cor{\xi}{\cfalsity}}$ \BY{assumption} \pflabel{nnsatisfyxi+bot}
      \end{pfsteps*}
      By rule induction over Rules (\ref{rules:satormay}) on \pfref{nnsatisfyxi+bot}.
      \begin{byCases}
      \item[\text{(\ref{rule:CMSPossibly})}]
        \begin{pfsteps*}
        \item $\cmaysatisfy{e}{\cor{\xi}{\cfalsity}}$ \BY{assumption} \pflabel{maysatisfyxi+bot}
        \end{pfsteps*}
        By rule induction over Rules (\ref{rules:MaySatisfy}) on \pfref{maysatisfyxi+bot}, only two of them apply.
        \begin{byCases}
        \item[\text{(\ref{rule:CMSOr1})}]
          \begin{pfsteps*}
          \item $\cmaysatisfy{e}{\xi}$ \BY{assumption} \pflabel{maysatisfyxi}
          \item $\csatisfyormay{e}{\xi}$ \BY{Rule (\ref{rule:CMSPossibly}) on \pfref{maysatisfyxi}}
          \end{pfsteps*}

        \item[\text{(\ref{rule:CMSOr2})}]
          \begin{pfsteps*}
          \item $\cmaysatisfy{e}{\cfalsity}$ \BY{assumption} \pflabel{maysatisfybot}
          \item $\cnotmaysatisfy{e}{\cfalsity}$ \BY{Lemma \ref{lem:no-e-may-satisfy-falsity}} \pflabel{notmaysatisfybot}
          \end{pfsteps*}
          \pfref{maysatisfybot} and \pfref{notmaysatisfybot} is contradictory to each other.
        \end{byCases}

      \item[\text{(\ref{rule:CMSMust})}]
        \begin{pfsteps*}
        \item $\csatisfy{e}{\cor{\xi}{\cfalsity}}$ \BY{assumption} \pflabel{satisfyxi+bot}
        \end{pfsteps*}
        By rule induction over Rules (\ref{rules:Satisfy}) on \pfref{satisfyxi+bot}, only two of them apply.
        \begin{byCases}
        \item[\text{(\ref{rule:CSOr1})}]
          \begin{pfsteps*}
          \item $\csatisfy{e}{\xi}$ \BY{assumption} \pflabel{satisfyxi}
          \item $\csatisfyormay{e}{\xi}$ \BY{Rule (\ref{rule:CMSMust}) on \pfref{satisfyxi}}
          \end{pfsteps*}

        \item[\text{(\ref{rule:CSOr2})}]
          \begin{pfsteps*}
          \item $\csatisfy{e}{\cfalsity}$ \BY{assumption} \pflabel{satisfybot}
          \item $\cnotsatisfy{e}{\cfalsity}$ \BY{Lemma \ref{lem:no-e-satisfy-falsity}} \pflabel{notsatisfybot}
          \end{pfsteps*}
          \pfref{satisfybot} and \pfref{notsatisfybot} is contradictory to each other.
        \end{byCases}
      \resetpfcounter
      \end{byCases}
  \end{enumerate}
\end{proof}

\begin{corol}
  \label{corol:relax-nn-entail}
  $\csatisfyormay{\ctruth}{\xi}$ iff $\csatisfyormay{\ctruth}{\cor{\xi}{\cfalsity}}$
\end{corol}
\begin{proof}
  By Definition \ref{defn:nn-entailment} and Lemma \ref{lem:relax-nn-satisfy}.
\end{proof}

\begin{lem}
  \label{lem:relax-not-redundant}
  $\cnotsatisfy{\xi_1}{\xi_2}$ iff $\cnotsatisfy{\xi_1}{\cor{\xi_2}{\cfalsity}}$
\end{lem}
\begin{proof}We prove sufficiency and necessity separately.

\begin{enumerate}
\item Sufficiency:
  \begin{pfsteps*}
  \item $\cnotsatisfy{\xi_1}{\xi_2}$ \BY{assumption} \pflabel{1notsatisfy2}
  \end{pfsteps*}
  Assume, for the sake of contradiction, that $\csatisfy{\xi_1}{\cor{\xi_2}{\cfalsity}}$. 
  \begin{pfsteps*}
  \item $\csatisfy{\xi_1}{\cor{\xi_2}{\cfalsity}}$ \BY{assumption} \pflabel{1=>2+bot}
  \item $\ctyp{\xi_1}{\tau}$ \BY{Definition \ref{defn:const-entailment} over \pfref{1=>2+bot}} \pflabel{1CTyp}
  \item $\ctyp{\cor{\xi_2}{\cfalsity}}{\tau}$ \BY{Definition \ref{defn:const-entailment} over \pfref{1=>2+bot}} \pflabel{2+botCTyp}
  \item $\ctyp{\xi_2}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTOr}) on \pfref{2+botCTyp}} \pflabel{2CTyp}
  \end{pfsteps*}
  Let $\csatisfyormay{e}{\xi_1}$.
  \begin{pfsteps*}
  \item $\csatisfyormay{e}{\xi_1}$ \BY{assumption} \pflabel{satisfyormay1}
  \item $\csatisfy{e}{\cor{\xi_2}{\cfalsity}}$ \BY{Definition \ref{defn:const-entailment} over \pfref{1=>2+bot} on \pfref{satisfyormay1}} \pflabel{satisfy2+bot}
  \end{pfsteps*}

  By rule induction over Rules (\ref{rules:Satisfy}) on \pfref{satisfy2+bot}.
  \begin{byCases}
  \item[\text{(\ref{rule:CSOr1})}]
    \begin{pfsteps*}
    \item $\csatisfy{e}{\xi_2}$ \BY{assumption} \pflabel{satisfy2}
    \item If $\csatisfyormay{e}{\xi_1}$ then $\csatisfy{e}{\xi_2}$ \BY{Inference from \pfref{satisfyormay1} to \pfref{satisfy2}} \pflabel{1=>2}
    \item $\csatisfy{\xi_1}{\xi_2}$ \BY{Definition \ref{defn:const-entailment} on \pfref{1CTyp} and \pfref{2CTyp} and \pfref{1=>2}} \pflabel{1satisfy2}
    \end{pfsteps*}
    \pfref{1notsatisfy2} and \pfref{1satisfy2} are contradictory to each other.
  \item[\text{(\ref{rule:CSOr2})}]
    \begin{pfsteps*}
    \item $\csatisfy{e}{\cfalsity}$ \BY{assumption} \pflabel{satisfybot}
    \item $\cnotsatisfy{e}{\cfalsity}$ \BY{Lemma \ref{lem:no-e-satisfy-falsity}} \pflabel{notsatisfybot}
    \end{pfsteps*}
    \pfref{satisfybot} and \pfref{notsatisfybot} are contradictory to each other.
  \end{byCases}

  The conclusion holds as follow:
  \begin{enumerate}
    \item $\cnotsatisfy{\xi_1}{\cor{\xi_2}{\cfalsity}}$ 
  \end{enumerate}
  
\resetpfcounter
\item Necessity:
  \begin{pfsteps*}
  \item $\cnotsatisfy{\xi_1}{\cor{\xi_2}{\cfalsity}}$ \BY{assumption} \pflabel{1notentail2+bot}
  \end{pfsteps*}
  Assume, for the sake of contradiction, that $\csatisfy{\xi_1}{\xi_2}$.
  \begin{pfsteps*}
  \item $\csatisfy{\xi_1}{\xi_2}$ \BY{assumption} \pflabel{1entail2}
  \item $\ctyp{\xi_1}{\tau}$ \BY{Definition \ref{defn:const-entailment} over \pfref{1entail2}} \pflabel{1CTyp}
  \item $\ctyp{\xi_2}{\tau}$ \BY{Definition \ref{defn:const-entailment} over \pfref{1entail2}} \pflabel{2CTyp}
  \item $\ctyp{\cfalsity}{\tau}$ \BY{Rule (\ref{rule:CTFalsity})} \pflabel{botCTyp}
  \item $\ctyp{\cor{\xi_2}{\cfalsity}}{\tau}$ \BY{Rule (\ref{rule:CTOr}) on \pfref{2CTyp} and \pfref{botCTyp}} \pflabel{2+botCTyp}
  \end{pfsteps*}
  Let $\csatisfyormay{e}{\xi_1}$.
  \begin{pfsteps*}
  \item $\csatisfyormay{e}{\xi_1}$ \BY{assumption} \pflabel{satisfyormay1}
  \item $\csatisfy{e}{\xi_2}$ \BY{Definition \ref{defn:const-entailment} over \pfref{1entail2} on \pfref{satisfyormay1}} \pflabel{satisfy2}
  \item $\csatisfy{e}{\cor{\xi_2}{\cfalsity}}$ \BY{Rule (\ref{rule:CSOr1}) on \pfref{satisfy2}} \pflabel{satisfy2+bot}
  \item If $\csatisfyormay{e}{\xi_1}$ then $\csatisfy{e}{\cor{\xi_2}{\cfalsity}}$ \BY{Inference from \pfref{satisfyormay1} to \pfref{satisfy2+bot}} \pflabel{1=>2}
  \item $\csatisfy{\xi_1}{\cor{\xi_2}{\cfalsity}}$ \BY{Definition \ref{defn:const-entailment} on \pfref{1CTyp} and \pfref{2+botCTyp} and \pfref{1=>2}}
  \end{pfsteps*}

  The conclusion holds as follow:
  \begin{enumerate}
    \item $\cnotsatisfy{\xi_1}{\xi_2}$ 
  \end{enumerate}
\end{enumerate}
\end{proof}

\begin{lem}
  \label{lem:rule-append}
  If $\chrulstyp{\Gamma}{\Delta}{\xi_{pre}}{rs}{\tau}{\xi_{rs}}{\tau'}$ and $\chrultyp{\Gamma}{\Delta}{r}{\tau}{\xi_r}{\tau'}$ and $\cnotsatisfy{\xi_r}{\cor{\xi_{pre}}{\xi_{rs}}}$ then $\chrulstyp{\Gamma}{\Delta}{\xi_{pre}}{\rmpointer{\zruls{rs}{r}{\cdot}}}{\tau}{\cor{\xi_{rs}}{\xi_r}}{\tau'}$
\end{lem}
\begin{proof}
  By rule induction over Rules (\ref{rules:CTRules}) on typing judgement of $rs$.
  \begin{byCases}
  \item[\text{(\ref{rule:CTZeroRule})}]
    \begin{pfsteps*}
    \item $rs = \cdot$ \BY{assumption}
    \item $\xi_{rs} = \cfalsity$ \BY{assumption}
    \item $\chrultyp{\Gamma}{\Delta}{r}{\tau}{\xi_r}{\tau'}$ \BY{assumption} \pflabel{ruleType}
    \item $\cnotsatisfy{\xi_r}{\cor{\xi_{pre}}{\cfalsity}}$ \BY{assumption} \pflabel{pre+botnotredundant}
    \item $\cnotsatisfy{\xi_r}{\xi_{pre}}$ \BY{Lemma \ref{lem:relax-not-redundant} on \pfref{pre+botnotredundant}} \pflabel{prenotredundant}
    \item $\chrulstyp{\Gamma}{\Delta}{\cor{\xi_{pre}}{\xi_r}}{\cdot}{\tau}{\cfalsity}{\tau'}$ \BY{Rule (\ref{rule:CTZeroRule})} \pflabel{zeroType}
    \item $\chrulstyp{\Gamma}{\Delta}{\xi_{pre}}{\hrulesP{r}{\cdot}}{\tau}{\cor{\xi_r}{\cfalsity}}{\tau'}$ \BY{Rule (\ref{rule:CTRules}) on \pfref{ruleType} and \pfref{zeroType} and \pfref{prenotredundant}}
    \end{pfsteps*}

  \resetpfcounter

  \item[\text{(\ref{rule:CTRules})}]
    \begin{pfsteps*}
    \item $rs = \hrules{r'}{rs'}$ \BY{assumption}
    \item $\xi_{rs} = \cor{\xi_r'}{\xi_{rs}'}$ \BY{assumption}
    \item $\chrulstyp{\Gamma}{\Delta}{\xi_{pre}}{\hrulesP{r'}{rs'}}{\tau}{\cor{\xi_r'}{\xi_{rs}'}}{\tau'}$ \BY{assumption} \pflabel{rsType}
    \item $\chrultyp{\Gamma}{\Delta}{r}{\tau}{\xi_r}{\tau'}$ \BY{assumption} \pflabel{rType}
    \item $\cnotsatisfy{\xi_r}{\cor{\xi_{pre}}{\cor{\xi_r'}{\xi_{rs}'}}}$ \BY{assumption} \pflabel{pre+rsnotredundant}
    \item $\chrultyp{\Gamma}{\Delta}{r'}{\tau}{\xi_r'}{\tau'}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rsType}} \pflabel{r'Type}
    \item $\chrulstyp{\Gamma}{\Delta}{\cor{\xi_{pre}}{\xi_r'}}{rs'}{\tau}{\xi_r'}{\tau'}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rsType}} \pflabel{rs'Type}
    \item $\cnotsatisfy{\xi_r'}{\xi_{pre}}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rsType}} \pflabel{prenotredundant}
    \item $\chrulstyp{\Gamma}{\Delta}{\cor{\xi_{pre}}{\xi_r'}}{\rmpointer{\zruls{rs'}{r}{\cdot}}}{\tau}{\cor{\xi_{rs}'}{\xi_r}}{\tau'}$ \BY{IH on \pfref{rs'Type} and \pfref{rType} and \pfref{pre+rsnotredundant}} \pflabel{rs'+rType}
    \item $\chrulstyp{\Gamma}{\Delta}{\xi_{pre}}{\hrulesP{r'}{\rmpointer{\zruls{rs'}{r}{\cdot}}}}{\tau}{\cor{\xi_r'}{\cor{\xi_{rs}'}{\xi_r}}}{\tau'}$ \BY{Rule (\ref{rule:CTRules}) on \pfref{r'Type} and \pfref{rs'+rType} and \pfref{prenotredundant}}
    \end{pfsteps*}

  \resetpfcounter
  \end{byCases}
\end{proof}

\begin{defn}[Not Not Entailment of Constraints]
  \label{defn:nn-entailment}
  $\csatisfyormay{\xi_1}{\xi_2}$ iff $\ctyp{\xi_1}{\tau}$ and $\ctyp{\xi_2}{\tau}$ and for all $e$ such that $\hexptyp{\cdot}{\Gamma}{e}{\tau}$ and $\isFinal{e}$ we have $\csatisfyormay{e}{\xi_1}$ implies $\csatisfyormay{e}{\xi_2}$ 
\end{defn}

\begin{corol}
  \label{corol:nn-exhaust}
  Suppose that $\ctyp{\xi}{\tau}$ and $\hexptyp{\cdot}{\Gamma}{e}{\tau}$ and $\isFinal{e}$. Then $\csatisfyormay{\ctruth}{\xi}$ implies $\csatisfyormay{e}{\xi}$
\end{corol}
\begin{proof}
  \begin{pfsteps*}
  \item $\ctyp{\xi}{\tau}$ \BY{assumption} \pflabel{CTyp}
  \item $\hexptyp{\cdot}{\Gamma}{e}{\tau}$ \BY{assumption} \pflabel{eTyp}
  \item $\isFinal{e}$ \BY{assumption} \pflabel{eFinal}
  \item $\csatisfyormay{\ctruth}{\xi}$ \BY{assumption} \pflabel{entailormay}
  \item $\csatisfy{e_1}{\ctruth}$ \BY{Rule (\ref{rule:CSTruth})} \pflabel{satisfytop}
  \item $\csatisfyormay{e_1}{\ctruth}$ \BY{Rule (\ref{rule:CMSMust}) on \pfref{satisfytop}} \pflabel{satisfyormaytop}
  \item $\ctyp{\ctruth}{\tau}$ \BY{Rule (\ref{rule:CTTruth})} \pflabel{topCTyp}
  \item $\csatisfyormay{e_1}{\xi_r}$ \BY{Definition \ref{defn:nn-entailment} of \pfref{entailormay} on \pfref{topCTyp} and \pfref{CTyp} and \pfref{eTyp} and \pfref{eFinal} and \pfref{satisfyormaytop}}
  \end{pfsteps*}
  \resetpfcounter
\end{proof}

\begin{lem}
  \label{lem:or-nn-satisfy}
  If $\cnotsatisfyormay{e}{\xi_1}$ and $\cnotsatisfyormay{e}{\xi_2}$ then $\cnotsatisfyormay{e}{\cor{\xi_1}{\xi_2}}$
\end{lem}
\begin{proof}
  Assume, for the sake of contradiction, that $\csatisfyormay{e}{\cor{\xi_1}{\xi_2}}$.
\begin{pfsteps*}
\item $\csatisfyormay{e}{\cor{\xi_1}{\xi_2}}$ \BY{assumption} \pflabel{satormay1+2}
\item $\cnotsatisfyormay{e}{\xi_1}$ \BY{assumption} \pflabel{notsatormay1}
\item $\cnotsatisfyormay{e}{\xi_2}$ \BY{assumption} \pflabel{notsatormay2}
\end{pfsteps*}
By rule induction over Rules (\ref{rules:satormay}) on \pfref{satormay1+2}.
\begin{byCases}
\item[\text{(\ref{rule:CMSMust})}]
  \begin{pfsteps*}
  \item $\csatisfy{e}{\cor{\xi_1}{\xi_2}}$ \BY{assumption} \pflabel{satisfy1+2}
  \end{pfsteps*}
  By rule induction over Rules (\ref{rules:Satisfy}) on \pfref{satisfy1+2} and only two of them apply.
  \begin{byCases}

  \item[\text{(\ref{rule:CSOr1})}]
    \begin{pfsteps*}
    \item $\csatisfy{e}{\xi_1}$ \BY{assumption} \pflabel{satisfy1}
    \item $\csatisfyormay{e}{\xi_1}$ \BY{Rule (\ref{rule:CMSMust}) on \pfref{satisfy1}} \pflabel{satormay1}
    \end{pfsteps*}
    \pfref{satormay1} and \pfref{notsatormay1} are contradictory with each other.

  \item[\text{(\ref{rule:CSOr2})}]
    \begin{pfsteps*}
    \item $\csatisfy{e}{\xi_2}$ \BY{assumption} \pflabel{satisfy2}
    \item $\csatisfyormay{e}{\xi_2}$ \BY{Rule (\ref{rule:CMSMust}) on \pfref{satisfy2}} \pflabel{satormay2}
    \end{pfsteps*}
    \pfref{satormay2} and \pfref{notsatormay2} are contradictory with each other.

  \end{byCases}

\item[\text{(\ref{rule:CMSPossibly})}]
  \begin{pfsteps*}
  \item $\cmaysatisfy{e}{\cor{\xi_1}{\xi_2}}$ \BY{assumption} \pflabel{maysatisfy1+2}
  \end{pfsteps*}
  By rule induction over Rules (\ref{rules:MaySatisfy}) on \pfref{maysatisfy1+2} and only two of them apply.
  \begin{byCases}

  \item[\text{(\ref{rule:CMSOr1})}]
    \begin{pfsteps*}
    \item $\cmaysatisfy{e}{\xi_1}$ \BY{assumption} \pflabel{maysatisfy1}
    \item $\csatisfyormay{e}{\xi_1}$ \BY{Rule (\ref{rule:CMSPossibly}) on \pfref{maysatisfy1}} \pflabel{satormay1'}
    \end{pfsteps*}
    \pfref{satormay1'} and \pfref{notsatormay1} are contradictory with each other.

  \item[\text{(\ref{rule:CMSOr2})}]
    \begin{pfsteps*}
    \item $\cmaysatisfy{e}{\xi_2}$ \BY{assumption} \pflabel{maysatisfy2}
    \item $\csatisfyormay{e}{\xi_2}$ \BY{Rule (\ref{rule:CMSPossibly}) on \pfref{maysatisfy2}} \pflabel{satormay2'}
    \end{pfsteps*}
    \pfref{satormay2'} and \pfref{notsatormay2} are contradictory with each other.

  \end{byCases}
\end{byCases}
The conclusion holds as follow:
\begin{enumerate}
  \item $\csatisfyormay{\xi_1}{\xi_2}$
\end{enumerate}
\resetpfcounter
\end{proof}

\begin{lem}
  \label{lem:satisfy-substraction}
  If $\csatisfyormay{e}{\cor{\xi_1}{\xi_2}}$ and $\cnotsatisfyormay{e}{\xi_1}$ then $\csatisfyormay{e}{\xi_2}$
\end{lem}
\begin{proof}
  \begin{pfsteps*}
  \item $\csatisfyormay{e}{\cor{\xi_1}{\xi_2}}$ \BY{assumption} \pflabel{satormay1+2}
  \item $\cnotsatisfyormay{e}{\xi_1}$ \BY{assumption} \pflabel{notsatormay1}
  \end{pfsteps*}
  By rule induction over Rules (\ref{rules:satormay}) on \pfref{satormay1+2}.
  \begin{byCases}
  \item[\text{(\ref{rule:CMSMust})}]
    \begin{pfsteps*}
    \item $\csatisfy{e}{\cor{\xi_1}{\xi_2}}$ \BY{assumption} \pflabel{satisfy1+2}
    \end{pfsteps*}
    By rule induction over Rules (\ref{rules:Satisfy}) on \pfref{satisfy1+2} and only two of them apply.
    \begin{byCases}
    \item[\text{(\ref{rule:CSOr1})}]
      \begin{pfsteps*}
      \item $\csatisfy{e}{\xi_1}$ \BY{assumption} \pflabel{satisfy1}
      \item $\csatisfyormay{e}{\xi_1}$ \BY{Rule (\ref{rule:CMSMust}) on \pfref{satisfy1}}
      \end{pfsteps*}
      Contradictory to \pfref{notsatormay1}.
    \item[\text{(\ref{rule:CSOr2})}]
      \begin{pfsteps*}
      \item $\csatisfy{e}{\xi_2}$ \BY{assumption} \pflabel{satisfy2}
      \item $\csatisfyormay{e}{\xi_2}$ \BY{Rule (\ref{rule:CMSMust}) on \pfref{satisfy2}}
      \end{pfsteps*}
    \end{byCases}

  \item[\text{(\ref{rule:CMSPossibly})}]
    \begin{pfsteps*}
    \item $\cmaysatisfy{e}{\cor{\xi_1}{\xi_2}}$ \BY{assumption} \pflabel{maysatisfy1+2}
    \end{pfsteps*}
    By rule induction over Rules (\ref{rules:MaySatisfy}) on \pfref{maysatisfy1+2} and only two of them apply.
    \begin{byCases}
    \item[\text{(\ref{rule:CMSOr1})}]
      \begin{pfsteps*}
      \item $\cmaysatisfy{e}{\xi_1}$ \BY{assumption} \pflabel{maysatisfy1}
      \item $\csatisfyormay{e}{\xi_1}$ \BY{Rule (\ref{rule:CMSPossibly}) on \pfref{maysatisfy1}}
      \end{pfsteps*}
      Contradictory to \pfref{notsatormay1}.
    \item[\text{(\ref{rule:CMSOr2})}]
      \begin{pfsteps*}
      \item $\cmaysatisfy{e}{\xi_2}$ \BY{assumption} \pflabel{maysatisfy2}
      \item $\csatisfyormay{e}{\xi_2}$ \BY{Rule (\ref{rule:CMSPossibly}) on \pfref{maysatisfy2}}
      \end{pfsteps*}
    \end{byCases}
  \end{byCases}
\end{proof}

\begin{lem}
  \label{lem:rule-constraint-typ}
  If $\chrultyp{\cdot}{\Delta}{r}{\tau_1}{\xi_r}{\tau}$ then $\ctyp{\xi_r}{\tau_1}$.
\end{lem}

\begin{lem}
  \label{lem:rules-constraint-typ}
  If $\chrulstyp{\cdot}{\Delta}{\xi_{pre}}{rs}{\tau_1}{\xi_{rs}}{\tau}$ then $\ctyp{\xi_{rs}}{\tau_1}$.
\end{lem}

\begin{thm}[Preservation]
  \label{thrm:preservation}
  If $\hexptyp{\cdot}{\Delta}{e}{\tau}$ and $\htrans{e}{e'}$
  then $\hexptyp{\cdot}{\Delta}{e'}{\tau}$
\end{thm}

\begin{proof}
By rule induction over Rules (\ref{rules:CTExp}) on typing judgement of $e$.
For simplicity, we only consider two cases here.
\begin{byCases}
\item[\text{(\ref{rule:CTMatchZPre})}]
  \begin{pfsteps*}
  \item $\hexptyp{\cdot}{\Delta}{\hmatch{e_1}{\zruls{\cdot}{\hrulP{p_r}{e_r}}{rs}}}{\tau}$ \BY{assumption} \pflabel{expType}
  \item $\htrans{\hmatch{e_1}{\zruls{\cdot}{\hrulP{p_r}{e_r}}{rs}}}{e'}$ \BY{assumption} \pflabel{expTrans}
  \item $\hexptyp{\cdot}{\Delta}{e_1}{\tau_1}$ \BY{assumption} \pflabel{scrutType}
  \item $\chrulstyp{\cdot}{\Delta}{\cfalsity}{\hrulesP{\hrul{p_r}{e_r}}{rs}}{\tau_1}{\xi}{\tau}$ \BY{assumption} \pflabel{rulesType}
  \item $\csatisfyormay{\ctruth}{\xi}$ \BY{assumption} \pflabel{exhaust}
  \item $\xi = \cor{\xi_r}{\xi_{rs}}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rulesType}}
  \item $\chrultyp{\cdot}{\Delta}{\hrulP{p_r}{e_r}}{\tau_1}{\xi_r}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rulesType}} \pflabel{ruleType}
  \item $\chrulstyp{\cdot}{\Delta}{\cor{\cfalsity}{\xi_r}}{rs}{\tau_1}{\xi_{rs}}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rulesType}} \pflabel{postrulesType}
  \item $\cnotsatisfy{\xi_r}{\cfalsity}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rulesType}} \pflabel{notredundant}
  \item $\chpattyp{p_r}{\tau_1}{\xi_r}{\Gamma_r}{\Delta_r}$ \BY{Inversion of Rule (\ref{rule:CTRule}) on \pfref{ruleType}} \pflabel{patType}
  \item $\hexptyp{\cdot \uplus \Gamma_r}{\Delta \uplus \Delta_r}{e_r}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRule}) on \pfref{ruleType}} \pflabel{expinruleType}
  \end{pfsteps*}
  By rule induction over Rules (\ref{rules:ITExp}) on \pfref{expTrans}.
  \begin{byCases}
  \item[\text{(\ref{rule:ITExpMatch})}]
    \begin{pfsteps*}
    \item $e' = \hmatch{e_1'}{\zruls{\cdot}{\hrulP{p_r}{e_r}}{rs}}$ \BY{assumption}
    \item $\htrans{e_1}{e_1'}$ \BY{assumption} \pflabel{scrutTrans}
    \item $\hexptyp{\cdot}{\Delta}{e_1'}{\tau_1}$ \BY{IH over \pfref{scrutType} and \pfref{scrutTrans}} \pflabel{newscrutType}
    \item $\hexptyp{\cdot}{\Delta}{\hmatch{e_1'}{\zruls{\cdot}{\hrulP{p_r}{e_r}}{rs}}}{\tau}$ \BY{Rule (\ref{rule:CTMatchZPre}) on \pfref{newscrutType} and \pfref{rulesType} and \pfref{exhaust}}
    \end{pfsteps*}
  \item[\text{(\ref{rule:ITSuccMatch})}]
    \begin{pfsteps*}
    \item $e' = [\theta](e_r)$ \BY{assumption}
    \item $\hpatmatch{e_1}{p_r}{\theta}$ \BY{assumption} \pflabel{patMatch}
    \item $\hsubstyp{\theta}{\Gamma_r}$ \BY{Lemma \ref{lem:subs-typing} on \pfref{scrutType} and \pfref{patType} and \pfref{patMatch}} \pflabel{substType}
    \item $\hexptyp{\cdot}{\Delta \uplus \Delta_r}{[\theta](e_r)}{\tau}$ \BY{Lemma \ref{lem:simult-substitution} on \pfref{expinruleType} and \pfref{substType}}
    \end{pfsteps*}
  \item[\text{(\ref{rule:ITFailMatch})}]
    \begin{pfsteps*}
    \item $rs = \hrules{r'}{rs'}$ \BY{assumption}
    \item $e' = \hmatch{e_1}{\zruls{\hrulesP{\hrul{p_r}{e_r}}{\cdot}}{r'}{rs'}}$ \BY{assumption}
    \item $\isFinal{e_1}$ \BY{assumption} \pflabel{scrutFinal}
    \item $\hnotmatch{e_1}{p_r}$ \BY{assumption} \pflabel{patnotmatch}
    \item $\chrulstyp{\cdot}{\Delta}{\cor{\cfalsity}{\xi_r}}{\cdot}{\tau_1}{\cfalsity}{\tau}$ \BY{Rule \ref{rule:CTZeroRule}} \pflabel{zeroruleType}
    \item $\chrulstyp{\cdot}{\Delta}{\cfalsity}{\hrulesP{\hrul{p_r}{e_r}}{\cdot}}{\tau_1}{\cor{\xi_r}{\cfalsity}}{\tau}$ \BY{Rule \ref{rule:CTRules} on \pfref{ruleType} and \pfref{zeroruleType} and \pfref{notredundant}} \pflabel{pre+rType}
  \item $\csatisfy{e_1}{\cdual{\xi_r}}$ \BY{Lemma (\ref{lem:const-matching-coherence}) on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{patType} and \pfref{patnotmatch}} \pflabel{matchdual}
    \item $\cnotsatisfyormay{e_1}{\xi_r}$ \BY{Lemma (\ref{lem:neg-dual-satisfy}) on } \pflabel{notrConst}
  \item $\cnotsatisfyormay{e_1}{\cor{\xi_r}{\cfalsity}}$ \BY{Lemma (\ref{lem:relax-nn-satisfy}) on \pfref{notrConst}} \pflabel{notpre+rConst}
    \item $\csatisfyormay{\ctruth}{\cor{\cfalsity}{\cor{\xi_r}{\xi_{rs}}}}$ \BY{Lemma (\ref{corol:relax-nn-entail}) on \pfref{exhaust}} \pflabel{newexhaust}
    \item $\hexptyp{\cdot}{\Delta}{\hmatch{e_1}{\zruls{\hrulesP{\hrul{p_r}{e_r}}{\cdot}}{r'}{rs'}}}{\tau}$ \BY{Rule (\ref{rule:CTMatchNZPre}) on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{pre+rType} and \pfref{postrulesType} and \pfref{notpre+rConst} and \pfref{newexhaust}}
    \end{pfsteps*}
  \end{byCases}

  \resetpfcounter
\item[\text{(\ref{rule:CTMatchNZPre})}]
  \begin{pfsteps*}
  \item $rs_{pre} = \hrules{r}{rs}$ \BY{assumption}
  \item $\hexptyp{\cdot}{\Delta}{\hmatch{e_1}{\zruls{rs_{pre}}{\hrulP{p_r}{e_r}}{rs_{post}}}}{\tau}$ \BY{assumption} \pflabel{expType}
  \item $\htrans{\hmatch{e_1}{\zruls{rs_{pre}}{\hrulP{p_r}{e_r}}{rs_{post}}}}{e'}$ \BY{assumption} \pflabel{expTrans}
  \item $\hexptyp{\cdot}{\Delta}{e_1}{\tau_1}$ \BY{assumption} \pflabel{scrutType}
  \item $\isFinal{e_1}$ \BY{assumption} \pflabel{scrutFinal}
  \item $\chrulstyp{\cdot}{\Delta}{\cfalsity}{rs_{pre}}{\tau_1}{\xi_{pre}}{\tau}$ \BY{assumption} \pflabel{prerulesType}
  \item $\chrulstyp{\cdot}{\Delta}{\xi_{pre}}{\hrulesP{\hrul{p_r}{e_r}}{rs_{post}}}{\tau_1}{\xi_{rest}}{\tau}$ \BY{assumption} \pflabel{restrulesType}
  \item $\cnotsatisfyormay{e_1}{\xi_{pre}}$ \BY{assumption} \pflabel{notsatisfypre}
  \item $\csatisfyormay{\ctruth}{\cor{\xi_{pre}}{\xi_{rest}}}$ \BY{assumption} \pflabel{exhaust}
  \item $\xi_{rest} = \cor{\xi_r}{\xi_{post}}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{restrulesType}}
  \item $\chrultyp{\cdot}{\Delta}{\hrulP{p_r}{e_r}}{\tau_1}{\xi_r}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{restrulesType}} \pflabel{ruleType}
  \item $\chrulstyp{\cdot}{\Delta}{\cor{\xi_{pre}}{\xi_r}}{rs_{post}}{\tau_1}{\xi_{post}}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{restrulesType}} \pflabel{postrulesType}
  \item $\cnotsatisfy{\xi_r}{\xi_{pre}}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{restrulesType}} \pflabel{notredundant}
  \item $\chpattyp{p_r}{\tau_1}{\xi_r}{\Gamma_r}{\Delta_r}$ \BY{Inversion of Rule (\ref{rule:CTRule}) on \pfref{ruleType}} \pflabel{patType}
  \item $\hexptyp{\cdot \uplus \Gamma_r}{\Delta \uplus \Delta_r}{e_r}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRule}) on \pfref{ruleType}} \pflabel{expinruleType}
  \end{pfsteps*}
  By rule induction over Rules (\ref{rules:ITExp}) on \pfref{expTrans}.
  \begin{byCases}
  \item[\text{(\ref{rule:ITExpMatch})}]
    \begin{pfsteps*}
    \item $e' = \hmatch{e_1}{\zruls{rs_{pre}}{\hrulP{p_r}{e_r}}{rs_{post}}}$ \BY{assumption}
    \item $\htrans{e_1}{e_1'}$ \BY{assumption} \pflabel{scrutTrans}
    \item contradiction \BY{Lemma \ref{lem:finality} on \pfref{scrutFinal} and \pfref{scrutTrans}}
    \end{pfsteps*}
  
  \item[\text{(\ref{rule:ITSuccMatch})}]
    \begin{pfsteps*}
    \item $e' = [\theta](e_r)$ \BY{assumption}
    \item $\hpatmatch{e_1}{p_r}{\theta}$ \BY{assumption} \pflabel{patMatch}
    \item $\hsubstyp{\theta}{\Gamma_r}$ \BY{Lemma \ref{lem:subs-typing} on \pfref{scrutType} and \pfref{patType} and \pfref{patMatch}} \pflabel{substType}
    \item $\hexptyp{\cdot}{\Delta \uplus \Delta_r}{[\theta](e_r)}{\tau}$ \BY{Lemma \ref{lem:simult-substitution} on \pfref{expinruleType} and \pfref{substType}}
    \end{pfsteps*}
  
  \item[\text{(\ref{rule:ITFailMatch})}]
    \begin{pfsteps*}
    \item $rs_{post} = \hrules{r'}{rs'}$ \BY{assumption}
    \item $\hnotmatch{e_1}{p_r}$ \BY{assumption} \pflabel{patnotmatch}
    \item $\cnotsatisfy{\xi_r}{\cor{\cfalsity}{\xi_{pre}}}$ \BY{Lemma \ref{lem:relax-not-redundant} on \pfref{notredundant}} \pflabel{bot+prenotredundant}
    \item $\chrulstyp{\cdot}{\Delta}{\cfalsity}{\rmpointer{\zruls{rs_{pre}}{\hrul{p_r}{e_r}}{\cdot}}}{\tau_1}{\cor{\xi_{pre}}{\xi_r}}{\tau}$ \BY{Lemma \ref{lem:rule-append} on \pfref{prerulesType} and \pfref{ruleType} and \pfref{bot+prenotredundant}} \pflabel{pre+rrulesType}
    \item $\csatisfy{e_1}{\cdual{\xi_r}}$ \BY{Lemma \ref{lem:const-matching-coherence} on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{patType} and \pfref{patnotmatch}} \pflabel{constnotmatch}
    \item $\cnotsatisfyormay{e_1}{\xi_r}$ \BY{Lemma \ref{lem:neg-dual-satisfy} on \pfref{constnotmatch}} \pflabel{notsatisfyr}
    \item $\cnotsatisfyormay{e_1}{\cor{\xi_{pre}}{\xi_r}}$ \BY{Lemma \ref{lem:or-nn-satisfy} on \pfref{notsatisfypre} and \pfref{notsatisfyr}} \pflabel{notsatisfypre+r}
    \item $\hexptyp{\cdot}{\Delta}{\hmatch{e_1}{\zruls{\rmpointer{\zruls{rs_{pre}}{\hrul{p_r}{e_r}}{\cdot}}}{r'}{rs'}}}{\tau}$ \BY{Rule (\ref{rule:CTMatchNZPre}) on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{pre+rrulesType} and \pfref{postrulesType} and \pfref{notsatisfypre+r} and \pfref{exhaust}} 
    \end{pfsteps*}
  \end{byCases}
\resetpfcounter
\end{byCases}
\end{proof}

\begin{thm}[Progress]
 \label{thrm:progress}
 If $\hexptyp{\cdot}{\cdot}{e}{\tau}$ then either $\isFinal{e}$ or $\htrans{e}{e'}$ for some $e'$.
\end{thm}

\begin{proof}
By rule induction over Rules (\ref{rules:CTExp}) on \pfref{expType}. For simplicity, we only consider two cases here.
\begin{byCases}
\item[\text{(\ref{rule:CTMatchZPre})}]
  \begin{pfsteps*}
  \item $\hexptyp{\cdot}{\Delta}{\hmatch{e_1}{\zruls{\cdot}{r}{rs}}}{\tau}$ \BY{assumption} \pflabel{expType}
  \item $\hexptyp{\cdot}{\Delta}{e_1}{\tau_1}$ \BY{assumption} \pflabel{scrutType}
  \item $\chrulstyp{\cdot}{\Delta}{\cfalsity}{\hrulesP{r}{rs}}{\tau_1}{\xi}{\tau}$ \BY{assumption} \pflabel{rulesType}
  \item $\csatisfyormay{\ctruth}{\xi}$ \BY{assumption} \pflabel{exhaust}
  \item $\xi = \cor{\xi_r}{\xi_{rs}}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rulesType}}
  \item $\chrultyp{\cdot}{\Delta}{r}{\tau_1}{\xi_r}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rulesType}} \pflabel{ruleType}
  \item $\chrulstyp{\cdot}{\Delta}{\cor{\cfalsity}{\xi_r}}{rs}{\tau_1}{\xi_{rs}}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rulesType}} \pflabel{postrulesType}
  \item $\cnotsatisfy{\xi_r}{\cfalsity}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{rulesType}} \pflabel{notredundant}
  \item $r = \hrul{p_r}{e_r}$ \BY{Inversion of Rule (\ref{rule:CTRule}) on \pfref{ruleType}}
  \item $\chpattyp{p_r}{\tau_1}{\xi_r}{\Gamma_r}{\Delta_r}$ \BY{Inversion of Rule (\ref{rule:CTRule}) on \pfref{ruleType}} \pflabel{patType}
  \end{pfsteps*}
  By IH on \pfref{scrutType}.
  \begin{byCases}
  \item[\text{Scrutinee takes a step}]
    \begin{pfsteps*}
    \item $\htrans{e_1}{e_1'}$ \BY{assumption} \pflabel{scrutStep}
    \item $\htrans{\hmatch{e_1}{\zruls{\cdot}{r}{rs}}}{\hmatch{e_1'}{\zruls{\cdot}{r}{rs}}}$ \BY{Rule (\ref{rule:ITExpMatch}) on \pfref{scrutStep}}
    \end{pfsteps*}
  \item[\text{Scrutinee is final}]
    \begin{pfsteps*}
    \item $\isFinal{e_1}$ \BY{assumption} \pflabel{scrutFinal}
    \end{pfsteps*}
    By rule induction over Rules (\ref{rules:CTRules}) on \pfref{postrulesType}.
    \begin{byCases}
    \item[\text{(\ref{rule:CTZeroRule})}]
      \begin{pfsteps*}
      \item $rs = \cdot$ \BY{assumption}
      \item $\xi_{rs} = \cfalsity$ \BY{assumption}
      \item $\csatisfyormay{\ctruth}{\xi_r}$ \BY{Corollary \ref{corol:relax-nn-entail} on \pfref{exhaust}} \pflabel{exhaustr}
      \item $\csatisfyormay{e_1}{\xi_r}$ \BY{Corollary \ref{corol:nn-exhaust} on \pfref{scrutFinal} and \pfref{exhaustr}} \pflabel{satormayr}
      \end{pfsteps*}
      By rule induction over Rules (\ref{rules:satormay}) on \pfref{satormayr}.
      \begin{byCases}
      \item[\text{(\ref{rule:CMSPossibly})}]
        \begin{pfsteps*}
        \item $\cmaysatisfy{e_1}{\xi_r}$ \BY{assumption} \pflabel{maysatr}
        \item $\hmaymatch{e_1}{p_r}$ \BY{Lemma \ref{lem:const-matching-coherence} on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{patType} and \pfref{maysatr}} \pflabel{maymatchr}
        \item $\isIndet{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{\cdot}}}$ \BY{Rule (\ref{rule:IMayMatch}) on \pfref{scrutFinal} and \pfref{maymatchr}} \pflabel{matchIndet}
        \item $\isFinal{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{\cdot}}}$ \BY{Rule (\ref{rule:FIndet}) on \pfref{matchIndet}}
        \end{pfsteps*}
      \item[\text{(\ref{rule:CMSMust})}]
        \begin{pfsteps*}
        \item $\csatisfy{e_1}{\xi_r}$ \BY{assumption} \pflabel{satisfyr}
        \item $\hpatmatch{e_1}{p_r}{\theta}$ \BY{Lemma \ref{lem:const-matching-coherence} on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{patType} and \pfref{satisfyr}} \pflabel{matchr}
        \item $\htrans{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{\cdot}}}{[\theta](e_r)}$ \BY{Rule (\ref{rule:ITSuccMatch}) on \pfref{scrutFinal} and \pfref{matchr}}
        \end{pfsteps*}
      \end{byCases}
    \item[\text{(\ref{rule:CTRules})}]
      \begin{pfsteps*}
      \item $rs = \hrules{r'}{rs'}$ \BY{assumption}
      \end{pfsteps*}
      By Lemma \ref{lem:match-determinism} on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{patType}.
      \begin{byCases}
      \item[\text{Scrutinee matches pattern}]
        \begin{pfsteps*}
        \item $\hpatmatch{e_1}{p_r}{\theta}$ \BY{assumption} \pflabel{succmatch}
        \item $\htrans{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{rs}}}{[\theta](e_r)}$ \BY{Rule (\ref{rule:ITSuccMatch}) on \pfref{scrutFinal} and \pfref{succmatch}}
        \end{pfsteps*}
      \item[\text{Scrutinee may matches pattern}]
        \begin{pfsteps*}
        \item $\hmaymatch{e_1}{p_r}$ \BY{assumption} \pflabel{maymatch}
        \item $\isIndet{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{rs}}}$ \BY{Rule (\ref{rule:IMayMatch}) on \pfref{scrutFinal} and \pfref{maymatch}} \pflabel{indetmatch}
        \item $\isFinal{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{rs}}}$ \BY{Rule (\ref{rule:FIndet}) on \pfref{indetmatch}}
        \end{pfsteps*}
      \item[\text{Scrutinee doesn't matche pattern}]
        \begin{pfsteps*}
        \item $\hnotmatch{e_1}{p_r}$ \BY{assumption} \pflabel{notmatch}
        \item $\hlongtrans{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{\hrulesP{r'}{rs'}}}}{\hmatch{e_1}{\zruls{\hrulesP{\hrul{p_r}{e_r}}{\cdot}}{r'}{rs'}}}$ \BY{Rule (\ref{rule:ITFailMatch}) on \pfref{scrutFinal} and \pfref{notmatch}}
        \end{pfsteps*}
      \end{byCases}
    \end{byCases}
  \end{byCases}
    
\resetpfcounter
\item[\text{(\ref{rule:CTMatchNZPre})}]
  \begin{pfsteps*}
  \item $rs_{pre} = \hrules{r_{pre}}{rs_{pre}'} \BY{assumption}
  \item $\hexptyp{\cdot}{\Delta}{\hmatch{e_1}{\zruls{rs_{pre}}{r}{rs_{post}}}}{\tau}$ \BY{assumption} \pflabel{expType}
  \item $\hexptyp{\cdot}{\Delta}{e_1}{\tau_1}$ \BY{assumption} \pflabel{scrutType}
  \item $\isFinal{e_1}$ \BY{assumption} \pflabel{scrutFinal}
  \item $\chrulstyp{\cdot}{\Delta}{\xi_{pre}}{\hrulesP{r}{rs_{post}}}{\tau_1}{\xi_{rest}}{\tau}$ \BY{assumption} \pflabel{restrulesType}
  \item $\cnotsatisfyormay{e_1}{\xi_{pre}}$ \BY{assumption} \pflabel{notsatisfypre}
  \item $\csatisfyormay{\ctruth}{\cor{\xi_{pre}}{\xi_{rest}}}$ \BY{assumption} \pflabel{exhaust}
  \item $\xi_{rest} = \cor{\xi_r}{\xi_{post}}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{restrulesType}}
  \item $\chrultyp{\cdot}{\Delta}{r}{\tau_1}{\xi_r}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{restrulesType}} \pflabel{ruleType}
  \item $\chrulstyp{\cdot}{\Delta}{\cor{\xi_{pre}}{\xi_r}}{rs_{post}}{\tau_1}{\xi_{post}}{\tau}$ \BY{Inversion of Rule (\ref{rule:CTRules}) on \pfref{restrulesType}} \pflabel{postrulesType}
  \item $r = \hrul{p_r}{e_r}$ \BY{Inversion of Rule (\ref{rule:CTRule}) on \pfref{ruleType}}
  \item $\chpattyp{p_r}{\tau_1}{\xi_r}{\Gamma_r}{\Delta_r}$ \BY{Inversion of Rule (\ref{rule:CTRule}) on \pfref{ruleType}} \pflabel{patType}
  \end{pfsteps*}
  By rule induction over Rules (\ref{rules:CTRules}) on \pfref{postrulesType}.
  \begin{byCases}
  \item[\text{(\ref{rule:CTZeroRule})}]
    \begin{pfsteps*}
    \item $rs_{post} = \cdot$ \BY{assumption}
    \item $\xi_{post} = \cfalsity$ \BY{assumption}
    \item $\csatisfyormay{e_1}{\cor{\xi_{pre}}{\cor{\xi_r}{\cfalsity}}}$ \BY{Corollary \ref{corol:nn-exhaust} on \pfref{scrutFinal} and \pfref{exhaust}} \pflabel{satisfypre+r+bot}
    \item $\csatisfyormay{e_1}{\cor{\xi_{pre}}{\xi_r}}$ \BY{Lemma \ref{lem:relax-nn-satisfy} on \pfref{satisfypre+r+bot}} \pflabel{satisfypre+r}
    \item $\csatisfyormay{e_1}{\xi_r}$ \BY{Lemma \ref{lem:satisfy-substraction} on \pfref{satisfypre+r} and \pfref{notsatisfypre}} \pflabel{satormayr}
    \end{pfsteps*}
    By rule induction over Rules (\ref{rules:satormay}) on \pfref{satormayr}.
    \begin{byCases}
    \item[\text{(\ref{rule:CMSPossibly})}]
      \begin{pfsteps*}
      \item $\cmaysatisfy{e_1}{\xi_r}$ \BY{assumption} \pflabel{maysatr}
      \item $\hmaymatch{e_1}{p_r}$ \BY{Lemma \ref{lem:const-matching-coherence} on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{patType} and \pfref{maysatr}} \pflabel{maymatchr}
      \item $\isIndet{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{\cdot}}}$ \BY{Rule (\ref{rule:IMayMatch}) on \pfref{scrutFinal} and \pfref{maymatchr}} \pflabel{matchIndet}
      \item $\isFinal{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{\cdot}}}$ \BY{Rule (\ref{rule:FIndet}) on \pfref{matchIndet}}
      \end{pfsteps*}
    \item[\text{(\ref{rule:CMSMust})}]
      \begin{pfsteps*}
      \item $\csatisfy{e_1}{\xi_r}$ \BY{assumption} \pflabel{satisfyr}
      \item $\hpatmatch{e_1}{p_r}{\theta}$ \BY{Lemma \ref{lem:const-matching-coherence} on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{patType} and \pfref{satisfyr}} \pflabel{matchr}
      \item $\htrans{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{\cdot}}}{[\theta](e_r)}$ \BY{Rule (\ref{rule:ITSuccMatch}) on \pfref{scrutFinal} and \pfref{matchr}}
      \end{pfsteps*}
    \end{byCases}
  \item[\text{(\ref{rule:CTRules})}]
    \begin{pfsteps*}
    \item $rs_{post} = \hrules{r'}{rs_{post}'}$ \BY{assumption}
    \end{pfsteps*}
    By Lemma \ref{lem:match-determinism} on \pfref{scrutType} and \pfref{scrutFinal} and \pfref{patType}.
    \begin{byCases}
    \item[\text{Scrutinee matches pattern}]
      \begin{pfsteps*}
      \item $\hpatmatch{e_1}{p_r}{\theta}$ \BY{assumption} \pflabel{succmatch}
      \item $\htrans{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{rs_{post}}}}{[\theta](e_r)}$ \BY{Rule (\ref{rule:ITSuccMatch}) on \pfref{scrutFinal} and \pfref{succmatch}}
      \end{pfsteps*}
    \item[\text{Scrutinee may matches pattern}]
      \begin{pfsteps*}
      \item $\hmaymatch{e_1}{p_r}$ \BY{assumption} \pflabel{maymatch}
      \item $\isIndet{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{rs_{post}}}}$ \BY{Rule (\ref{rule:IMayMatch}) on \pfref{scrutFinal} and \pfref{maymatch}} \pflabel{indetmatch}
      \item $\isFinal{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{rs_{post}}}}$ \BY{Rule (\ref{rule:FIndet}) on \pfref{indetmatch}}
      \end{pfsteps*}
    \item[\text{Scrutinee doesn't matche pattern}]
      \begin{pfsteps*}
      \item $\hnotmatch{e_1}{p_r}$ \BY{assumption} \pflabel{notmatch}
      \item $\hlongtrans{\hmatch{e_1}{\zruls{\cdot}{\hrul{p_r}{e_r}}{\hrulesP{r'}{rs_{post}'}}}}{\hmatch{e_1}{\zruls{\hrulesP{\hrul{p_r}{e_r}}{\cdot}}{r'}{rs_{post}'}}}$ \BY{Rule (\ref{rule:ITFailMatch}) on \pfref{scrutFinal} and \pfref{notmatch}}
      \end{pfsteps*}
      \end{byCases}
  \end{byCases}
\end{byCases}
\end{proof}
